{% extends "base.html" %}
{% load static humanize %}
{% block back_button %}
<a href="javascript:history.back()" class="inline-block bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded mb-4">
  ‚¨ÖÔ∏è –ù–∞–∑–∞–¥
</a>
{% endblock %}
{% block content %}

<!-- üîî –°–æ–æ–±—â–µ–Ω–∏—è Django -->
{% if messages %}
<ul class="text-center text-green-600 text-sm mb-4">
  {% for message in messages %}
  <li>{{ message }}</li>
  {% endfor %}
</ul>
{% endif %}

<div class="flex flex-col md:flex-row p-10 gap-8">

  <!-- üñº –§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ -->
  <div class="w-full md:w-1/3 rounded-lg shadow">
    {% if item.image %}
      <img
        class="rounded"
        src="{{ item.image.url }}"
        alt="{{ item.name }}"
        title="{{ item.name }}"
      />
    {% else %}
      <img
        class="rounded"
        src="{% static 'img/default/default-image.png' %}"
        alt="No Image"
        title="No Image"
      />
    {% endif %}
  </div>

  <!-- üìÑ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
  <div class="flex-1">
    <h2 class="text-2xl font-bold mb-2">{{ item.name }}</h2>
    <p class="text-xl text-green-600 mb-2">${{ item.price|intcomma }}</p>
    <p class="text-gray-700 mb-4">{{ item.description }}</p>

    <!-- üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü -->
    <p class="text-sm text-gray-500">
      –ü—Ä–æ–¥–∞–≤–µ—Ü:
      <a
        class="text-blue-600"
        href="{% url 'users:sellerprofile' item.seller.id %}"
      >
        @{{ item.seller }}
      </a>
    </p>
    <p class="text-sm text-gray-500 mb-4">
      –¢–µ–ª–µ—Ñ–æ–Ω: {{ item.seller.profile.contact_number }}
    </p>

    <!-- ‚úèÔ∏è –ö–Ω–æ–ø–∫–∏ "–æ–±–Ω–æ–≤–∏—Ç—å" –∏ "—É–¥–∞–ª–∏—Ç—å" -->
    {% if request.user == item.seller %}
    <div class="flex gap-4 mb-4">
      <a
        class="bg-yellow-500 text-white px-4 py-2 rounded"
        href="{% url 'products:update_item' item.id %}"
        >–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a
      >
      <a
        class="bg-red-500 text-white px-4 py-2 rounded"
        href="{% url 'products:delete_item' item.id %}"
        >–£–¥–∞–ª–∏—Ç—å</a
      >
    </div>
    {% endif %}

    <!-- üí≥ Checkout –∫–Ω–æ–ø–∫–∞ -->
    {% if user.is_authenticated %}
    <button class="bg-green-600 text-white px-5 py-2 rounded" id="checkout">
      –ö—É–ø–∏—Ç—å
    </button>
    {% else %}
    <p class="text-red-500">–ß—Ç–æ–±—ã –∫—É–ø–∏—Ç—å —Ç–æ–≤–∞—Ä, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.</p>
    {% endif %}
  </div>
</div>

<!-- üí≥ Stripe –∏ checkout –ª–æ–≥–∏–∫–∞ -->
{% block extra_scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("{{ stripe_publishable_key }}");
  const checkoutButton = document.getElementById("checkout");

  if (checkoutButton) {
    checkoutButton.addEventListener("click", () => {
      fetch("{% url 'products:api_checkout_session' item.id %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Content-Type": "application/json",
        },
        body: JSON.stringify({}),
      })
        .then((res) => res.json())
        .then((data) => {
          return stripe.redirectToCheckout({ sessionId: data.sessionId });
        })
        .catch((err) => {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏:", err);
        });
    });
  }

  // üîí CSRF
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
{% endblock %}
