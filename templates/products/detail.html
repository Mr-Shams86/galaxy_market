{% extends "base.html" %}
{% load static humanize %}
{% block content %}

<!-- üîî –°–æ–æ–±—â–µ–Ω–∏—è Django -->
{% if messages %}
<ul class="text-center text-green-600 text-sm mb-4">
  {% for message in messages %}
  <li>{{ message }}</li>
  {% endfor %}
</ul>
{% endif %}

<div class="bg-white/10 backdrop-blur-md rounded-xl border border-white/20 text-white max-w-5xl mx-auto mt-10 p-8 shadow-lg">

  <div class="flex flex-col md:flex-row gap-8 items-start">

    <!-- üñº –§–æ—Ç–æ -->
    <div class="w-full md:w-1/2">
      {% if item.image %}
        <img
          class="rounded-xl shadow-lg max-w-md w-full h-auto mx-auto"
          src="{{ item.image.url }}"
          alt="{{ item.name }}"
          title="{{ item.name }}"
        />
      {% else %}
        <img
          class="rounded-xl shadow-lg max-w-md w-full h-auto mx-auto"
          src="{% static 'img/default/default-image.png' %}"
          alt="No Image"
          title="No Image"
        />
      {% endif %}
    </div>

    <!-- üìÑ –ò–Ω—Ñ–æ -->
    <div class="flex-1 space-y-4">
      <h2 class="text-3xl font-bold">{{ item.name }}</h2>
      <p class="text-xl text-green-400">${{ item.price|intcomma }}</p>
      <p class="text-gray-200">{{ item.description }}</p>

      <p class="text-sm text-gray-300">
        –ü—Ä–æ–¥–∞–≤–µ—Ü:
        <a href="{% url 'users:sellerprofile' item.seller.id %}" class="text-blue-400 underline">
          @{{ item.seller }}
        </a>
      </p>
      <p class="text-sm text-gray-400">
        –¢–µ–ª–µ—Ñ–æ–Ω: {{ item.seller.profile.contact_number }}
      </p>

      {% if request.user == item.seller %}
      <div class="flex flex-wrap gap-4">
        <a class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded" href="{% url 'products:update_item' item.id %}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        <a class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded" href="{% url 'products:delete_item' item.id %}">–£–¥–∞–ª–∏—Ç—å</a>
      </div>
      {% endif %}

      {% if user.is_authenticated %}
      <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded shadow" id="checkout">
        –ö—É–ø–∏—Ç—å
      </button>

      {% else %}
      <p class="text-red-400">–ß—Ç–æ–±—ã –∫—É–ø–∏—Ç—å —Ç–æ–≤–∞—Ä, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.</p>
      {% endif %}

      <!-- üîΩ –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥ -->
      <div class="text-center mt-6">
        <a href="javascript:history.back()" class="inline-block bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">
          ‚¨ÖÔ∏è –ù–∞–∑–∞–¥
        </a>
      </div> 
    </div>

  </div>
</div>

<!-- üí≥ Stripe -->
{% block extra_scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("{{ stripe_publishable_key }}");
  const checkoutButton = document.getElementById("checkout");

  if (checkoutButton) {
    checkoutButton.addEventListener("click", () => {
      fetch("{% url 'products:api_checkout_session' item.id %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Content-Type": "application/json",
        },
        body: JSON.stringify({}),
      })
        .then((res) => res.json())
        .then((data) => {
          return stripe.redirectToCheckout({ sessionId: data.sessionId });
        })
        .catch((err) => {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏:", err);
        });
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
{% endblock %}
